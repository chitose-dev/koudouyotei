<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>行動予定表（デモ）</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --panel2:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --accent:#2563eb;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --panel:#121a2a;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#253047;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#60a5fa;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", Arial;
      overflow:hidden;
    }

    /* 1920x1080 base (auto scale) */
    .stage-wrap{
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:8px;
    }
    .stage{
      width:1920px; height:1080px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      display:flex; flex-direction:column;
      box-shadow: var(--shadow);
      transform-origin:center center;
    }
    @media (max-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vw - 16px)/1920)); }
    }
    @media (min-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vh - 16px)/1080)); }
    }

    header{
      height:92px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel2), var(--bg));
    }
    .title{
      font-size:34px;
      font-weight:850;
      letter-spacing:.02em;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .clock{
      font-size:22px;
      color:var(--muted);
      font-weight:650;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      font-weight:750;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background:var(--accent);
      border-color:transparent;
      color:white;
    }

    .main{
      flex:1;
      display:flex;
      gap:14px;
      padding:14px;
      min-height:0;
    }
    .left{
      flex: 0 0 70%;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right{
      flex: 0 0 30%;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
      min-height:0;
    }
    .panel{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      min-height:0;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:22px;
    }
    thead th{
      text-align:left;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      font-size:22px;
      font-weight:900;
    }
    /* 縦線（ヘッダー） */
    thead th{
      border-right:1px solid var(--border);
    }
    thead th:last-child{
      border-right:none;
    }

    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      height:74px;
      vertical-align:middle;
      position:relative;
      /* 縦線（ボディ） */
      border-right:1px solid var(--border);
    }
    tbody td:last-child{
      border-right:none;
    }

    tbody tr:last-child td{ border-bottom:none; }
    .col-name{ width:26%; }
    .col-dest{ width:54%; }
    .col-time{ width:20%; }

    .cell{
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      overflow:hidden;
    }
    .cell.placeholder{
      color:var(--muted);
      font-weight:650;
    }
    .droppable{
      outline: 2px dashed transparent;
      outline-offset: -6px;
      border-radius:12px;
    }
    .droppable.drag-over{
      outline-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }

    /* Square magnets (table chips) */
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:20px;
      border:1px solid color-mix(in srgb, var(--text) 14%, transparent);
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      user-select:none;
    }
    .chip.dragging{ opacity:.6; }

    /* Right: Poster */
    .poster{ flex:1; display:flex; flex-direction:column; min-height:0; }
    .poster-zone{
      flex:1;
      position:relative;
      cursor:pointer;
      user-select:none;
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--panel) 80%, transparent),
        color-mix(in srgb, var(--panel2) 80%, transparent)
      );
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:0;
    }
    .poster-zone img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Right: Magnets */
    .magnets{ flex:1; display:flex; flex-direction:column; min-height:0; }
    .magnets-body{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:0;
      min-height:0;
    }
    .mag-col{
      border-right:1px solid var(--border);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .mag-col:last-child{ border-right:none; }
    .mag-title{
      font-weight:900;
      font-size:18px;
      color:var(--muted);
      letter-spacing:.02em;
    }
    .mag-grid{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      grid-auto-rows: minmax(64px, auto);
      gap:10px;
      align-content:start;
      overflow:auto;
      padding-right:6px;
    }
    .mag{
      border:1px solid color-mix(in srgb, var(--text) 14%, transparent);
      border-radius:14px;
      padding:12px 10px;
      font-weight:950;
      font-size:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:grab;
      user-select:none;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      background: var(--panel);
    }
    .mag:active{ cursor:grabbing; transform:scale(.99); }
    .mag.dragging{ opacity:.6; }

    /* Delete drop zone (only while dragging) */
    .trash{
      position:fixed;
      left:14px;
      bottom:14px;
      width:240px;
      height:84px;
      border-radius:16px;
      border:1px dashed color-mix(in srgb, var(--text) 20%, transparent);
      background: color-mix(in srgb, var(--bg) 70%, transparent);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:900;
      color:var(--muted);
      font-weight:850;
    }
    .trash.show{ display:flex; }
    .trash.over{
      border-color: var(--accent);
      color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }

    /* Popovers */
    .popover{
      position:fixed;
      z-index:1000;
      width:480px;
      max-width: calc(100vw - 24px);
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .pop-head{
      padding:12px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .pop-head .h{
      font-weight:950;
      font-size:18px;
    }
    .icon-btn{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .pop-body{ padding:14px; display:flex; flex-direction:column; gap:12px; }
    .pick-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .pick{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:14px;
      padding:12px;
      font-weight:950;
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      user-select:none;
    }
    .pick:active{ transform:scale(.99); }
    .muted{ color:var(--muted); font-weight:800; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="text"], input[type="number"]{
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      font-weight:700;
      outline:none;
      width:100%;
    }
    input[type="number"]{ width:160px; }

    /* Settings modal (tabs) */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      z-index:1200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .backdrop.open{ display:flex; }

    .modal{
      width: 980px;
      max-width: 100%;
      max-height: 92vh;
      overflow:hidden;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
    }
    .modal-head .h{ font-size:20px; font-weight:950; }

    .tabs{
      display:flex;
      gap:8px;
      padding:10px 12px 12px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
    }
    .tab{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: color-mix(in srgb, var(--accent) 14%, var(--panel));
      border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
    }

    .modal-body{
      padding:16px;
      overflow:auto;
    }
    .section{
      display:none;
      gap:14px;
    }
    .section.active{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card h3{ margin:0; font-size:18px; font-weight:950; }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .list-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:14px;
      padding:10px 12px;
      font-weight:850;
    }
    .rm{
      cursor:pointer;
      font-weight:950;
      color:#ef4444;
      border:1px solid color-mix(in srgb, #ef4444 40%, transparent);
      background: color-mix(in srgb, #ef4444 10%, transparent);
      padding:6px 10px;
      border-radius:12px;
      user-select:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:999px;
      padding:10px 12px;
      font-weight:850;
    }
    .swatch{
      width:18px; height:18px;
      border-radius:6px;
      border:1px solid color-mix(in srgb, var(--text) 18%, transparent);
      display:inline-block;
    }
    input[type="color"]{
      width:52px; height:42px;
      border:1px solid var(--border);
      background:transparent;
      border-radius:12px;
      padding:4px;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="stage-wrap">
    <div class="stage" id="stage" data-theme="light">
      <header>
        <div class="title">行動予定表</div>
        <div class="header-right">
          <div class="clock" id="clock">--</div>
          <button class="btn primary" id="openSettingsBtn">設定</button>
        </div>
      </header>

      <div class="main">
        <!-- LEFT: TABLE -->
        <section class="left">
          <div style="flex:1; overflow:auto;">
            <table id="scheduleTable">
              <thead>
                <tr>
                  <th class="col-name">氏名</th>
                  <th class="col-dest">行先</th>
                  <th class="col-time">帰社時間</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </section>

        <!-- RIGHT -->
        <aside class="right">
          <!-- Poster -->
          <section class="panel poster">
            <div class="poster-zone" id="posterZone" title="設定を開く">
              <img id="posterImg" alt="poster" />
            </div>
          </section>

          <!-- Magnets -->
          <section class="panel magnets">
            <div class="magnets-body">
              <div class="mag-col">
                <div class="mag-title">名前</div>
                <div class="mag-grid" id="magNames"></div>
              </div>
              <div class="mag-col">
                <div class="mag-title">車</div>
                <div class="mag-grid" id="magCars"></div>
              </div>
              <div class="mag-col">
                <div class="mag-title">行先</div>
                <div class="mag-grid" id="magDests"></div>
              </div>
            </div>
          </section>
        </aside>
      </div>
    </div>
  </div>

  <!-- Trash drop zone -->
  <div class="trash" id="trash">削除</div>

  <!-- Settings Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-label="設定">
      <div class="modal-head">
        <div class="h">設定</div>
        <button class="btn primary" id="closeSettingsBtn">閉じる</button>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="display">表示</div>
        <div class="tab" data-tab="poster">ポスター</div>
        <div class="tab" data-tab="magnets">マグネット</div>
      </div>

      <div class="modal-body">
        <!-- 表示 -->
        <div class="section active" id="tab-display">
          <div class="card">
            <h3>テーマ</h3>
            <div class="row" style="justify-content:space-between;">
              <div class="pill">
                <span class="swatch" style="background:var(--panel)"></span>
                表示テーマ
              </div>
              <button class="btn" id="themeToggleInSettings">ダークに切替</button>
            </div>
          </div>
          <div class="card">
            <h3>（予約枠）</h3>
            <div class="muted">必要ならここに表示関連の設定を追加できます</div>
          </div>
        </div>

        <!-- ポスター -->
        <div class="section" id="tab-poster">
          <div class="card">
            <h3>切替</h3>
            <div class="row">
              <div class="pill">切替(秒)</div>
              <input type="number" id="posterInterval" min="1" value="6" />
            </div>
          </div>
          <div class="card">
            <h3>画像</h3>
            <div class="row">
              <input type="text" id="posterUrl" placeholder="画像URLを追加" />
              <button class="btn primary" id="addPosterBtn">追加</button>
            </div>
            <div class="list" id="posterList"></div>
          </div>
        </div>

        <!-- マグネット -->
        <div class="section" id="tab-magnets">
          <div class="card">
            <h3>タイプ別 色</h3>
            <div class="row" style="gap:14px;">
              <div class="pill">名前色 <input type="color" id="colorName" /></div>
              <div class="pill">車色 <input type="color" id="colorCar" /></div>
              <div class="pill">行先色 <input type="color" id="colorDest" /></div>
            </div>
          </div>

          <div class="card">
            <h3>追加 / 管理</h3>
            <div class="row">
              <input type="text" id="magValue" placeholder="追加する内容" />
              <select id="magType" class="btn" style="padding:12px 14px;">
                <option value="name">名前</option>
                <option value="car">車</option>
                <option value="dest">行先</option>
              </select>
              <input type="color" id="magColor" title="個別色" />
              <button class="btn primary" id="addMagBtn">追加</button>
            </div>
            <div class="list" id="magList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popover -->
  <div class="popover" id="popover" style="display:none;"></div>

<script>
(() => {
  const stage = document.getElementById('stage');
  const clockEl = document.getElementById('clock');
  const trash = document.getElementById('trash');

  // ---- State ----
  const state = {
    theme: 'light',

    posters: [
      'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1525182008055-f88b95ff7980?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1553877522-43269d4ea984?auto=format&fit=crop&w=1600&q=80'
    ],
    posterIntervalSec: 6,
    posterIndex: 0,
    posterCountdown: 6,

    typeColors: {
      name: '#E8F0FF',
      car:  '#EAF7EF',
      dest: '#FFF2E7',
      custom: '#EEF2F7',
      time: '#F3F4F6'
    },

    magnets: {
      name: [
        {label:'田中', color:null},
        {label:'佐藤', color:null},
        {label:'鈴木', color:null},
        {label:'高橋', color:null},
        {label:'伊藤', color:null},
        {label:'渡辺', color:null},
      ],
      car: [
        {label:'1234', color:null},
        {label:'5678', color:null},
        {label:'白ジムニー', color:null},
        {label:'黒ハイエース', color:null},
        {label:'9988', color:null},
      ],
      dest: [
        {label:'新宿', color:null},
        {label:'渋谷', color:null},
        {label:'品川', color:null},
        {label:'現場A', color:null},
        {label:'現場B', color:null},
        {label:'倉庫', color:null},
      ]
    },

    rows: [
      { name: [{type:'name',label:'田中'}], dest: [{type:'dest',label:'新宿'},{type:'car',label:'1234'}], time: '16:30' },
      { name: [{type:'name',label:'佐藤'}], dest: [{type:'dest',label:'現場A'}], time: '15:00' },
      { name: [{type:'name',label:'鈴木'}], dest: [{type:'car',label:'白ジムニー'},{type:'dest',label:'渋谷'}], time: '' },
      ...Array.from({length:9}).map(()=>({name:[],dest:[],time:''}))
    ]
  };

  // ---- Clock ----
  const pad2 = (n)=> String(n).padStart(2,'0');
  const jpDow = ['日','月','火','水','木','金','土'];
  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${d.getMonth()+1}月${d.getDate()}日（${jpDow[d.getDay()]}） ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  tickClock();
  setInterval(tickClock, 1000);

  // ---- Theme ----
  function setTheme(next){
    state.theme = next;
    stage.setAttribute('data-theme', next);
    const btn = document.getElementById('themeToggleInSettings');
    btn.textContent = next === 'dark' ? 'ライトに切替' : 'ダークに切替';
  }

  // ---- Poster ----
  const posterImg = document.getElementById('posterImg');
  function showPoster(){
    posterImg.src = state.posters[state.posterIndex] || '';
  }
  function posterTick(){
    state.posterCountdown -= 1;
    if(state.posterCountdown <= 0){
      state.posterIndex = (state.posterIndex + 1) % Math.max(state.posters.length, 1);
      state.posterCountdown = Math.max(1, Number(state.posterIntervalSec) || 6);
      showPoster();
    }
  }
  showPoster();
  setInterval(posterTick, 1000);

  // ---- Table render ----
  const tbody = document.getElementById('tbody');

  function chipBg(chip){
    return chip.color || state.typeColors[chip.type] || '#EEF2F7';
  }

  function chipEl(chip, {draggable=false, payload=null} = {}){
    const el = document.createElement('div');
    el.className = 'chip';
    el.style.background = chipBg(chip);
    el.textContent = chip.label;

    if(draggable){
      el.draggable = true;
      el.addEventListener('dragstart', (e)=>{
        el.classList.add('dragging');
        trash.classList.add('show');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('application/json', JSON.stringify(payload));
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
        trash.classList.remove('show');
        trash.classList.remove('over');
      });
    }
    return el;
  }

  function renderCell(cellDiv, rowIndex, key){
    cellDiv.innerHTML = '';
    if(key === 'time'){
      const v = state.rows[rowIndex].time;
      if(!v){
        const ph = document.createElement('span');
        ph.className = 'cell placeholder';
        ph.textContent = '';
        cellDiv.appendChild(ph);
        return;
      }
      cellDiv.appendChild(chipEl(
        {type:'time', label:v, color: state.typeColors.time},
        {draggable:true, payload:{ kind:'cellChip', row:rowIndex, key:'time' }}
      ));
      return;
    }

    const arr = state.rows[rowIndex][key] || [];
    if(arr.length === 0){
      const ph = document.createElement('span');
      ph.className = 'cell placeholder';
      ph.textContent = '';
      cellDiv.appendChild(ph);
      return;
    }
    arr.forEach((c, idx)=>{
      cellDiv.appendChild(chipEl(
        c,
        {draggable:true, payload:{ kind:'cellChip', row:rowIndex, key, index:idx }}
      ));
    });
  }

  function makeTd(rowIndex, key){
    const td = document.createElement('td');
    td.classList.add('droppable');
    td.dataset.row = rowIndex;
    td.dataset.key = key;

    const cell = document.createElement('div');
    cell.className = 'cell';
    td.appendChild(cell);

    td.addEventListener('click', (e)=>{
      e.stopPropagation();
      const rect = td.getBoundingClientRect();
      if(key === 'time') openTimePopover(rowIndex, rect);
      else openSelectPopover(rowIndex, key, rect);
    });

    td.addEventListener('dragover', (e)=>{ e.preventDefault(); td.classList.add('drag-over'); });
    td.addEventListener('dragleave', ()=> td.classList.remove('drag-over'));
    td.addEventListener('drop', (e)=>{
      e.preventDefault();
      td.classList.remove('drag-over');
      const payload = e.dataTransfer.getData('application/json');
      if(!payload) return;
      const data = JSON.parse(payload);

      if(data.kind === 'cellChip'){
        if(key === 'time'){
          if(data.key !== 'time') return;
          state.rows[rowIndex].time = state.rows[data.row].time;
          state.rows[data.row].time = '';
          renderTable();
          return;
        }
        if(data.key === 'time') return;

        const moved = state.rows[data.row][data.key].splice(data.index,1)[0];
        state.rows[rowIndex][key].push(moved);
        renderTable();
        return;
      }

      if(data.kind === 'magnet'){
        if(key === 'time') return;
        state.rows[rowIndex][key].push({type:data.type, label:data.label, color:data.color || null});
        renderTable();
      }
    });

    renderCell(cell, rowIndex, key);
    return td;
  }

  function renderTable(){
    tbody.innerHTML = '';
    state.rows.forEach((r, i)=>{
      const tr = document.createElement('tr');
      tr.appendChild(makeTd(i,'name'));
      tr.appendChild(makeTd(i,'dest'));
      tr.appendChild(makeTd(i,'time'));
      tbody.appendChild(tr);
    });
  }

  // ---- Magnets ----
  function magnetBg(type, item){
    return item.color || state.typeColors[type] || '#EEF2F7';
  }

  function renderMagnets(){
    const names = document.getElementById('magNames');
    const cars  = document.getElementById('magCars');
    const dests = document.getElementById('magDests');
    names.innerHTML = cars.innerHTML = dests.innerHTML = '';

    function addMag(container, type, item){
      const el = document.createElement('div');
      el.className = 'mag';
      el.draggable = true;
      el.style.background = magnetBg(type, item);
      el.textContent = item.label;

      el.addEventListener('dragstart', (e)=>{
        el.classList.add('dragging');
        trash.classList.add('show');
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('application/json', JSON.stringify({
          kind:'magnet',
          type,
          label:item.label,
          color:item.color || null
        }));
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
        trash.classList.remove('show');
        trash.classList.remove('over');
      });

      container.appendChild(el);
    }

    state.magnets.name.forEach(item=> addMag(names,'name',item));
    state.magnets.car.forEach(item=> addMag(cars,'car',item));
    state.magnets.dest.forEach(item=> addMag(dests,'dest',item));
  }

  // ---- Trash (delete when dropped) ----
  trash.addEventListener('dragover', (e)=>{ e.preventDefault(); trash.classList.add('over'); });
  trash.addEventListener('dragleave', ()=> trash.classList.remove('over'));
  trash.addEventListener('drop', (e)=>{
    e.preventDefault();
    trash.classList.remove('over');
    trash.classList.remove('show');
    const payload = e.dataTransfer.getData('application/json');
    if(!payload) return;
    const data = JSON.parse(payload);

    if(data.kind === 'cellChip'){
      if(data.key === 'time') state.rows[data.row].time = '';
      else state.rows[data.row][data.key].splice(data.index,1);
      renderTable();
    }
  });

  // ---- Settings modal ----
  const backdrop = document.getElementById('backdrop');
  const openSettingsBtn = document.getElementById('openSettingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const posterZone = document.getElementById('posterZone');

  function openSettings(){
    backdrop.classList.add('open');
    renderSettingsLists();
    document.getElementById('posterInterval').value = state.posterIntervalSec;
  }
  function closeSettings(){ backdrop.classList.remove('open'); }

  openSettingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', closeSettings);
  posterZone.addEventListener('click', openSettings);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeSettings(); });

  // Tabs
  const tabs = document.getElementById('tabs');
  function setActiveTab(key){
    tabs.querySelectorAll('.tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.tab === key);
    });
    document.querySelectorAll('.section').forEach(sec=>{
      sec.classList.toggle('active', sec.id === `tab-${key}`);
    });
  }
  tabs.addEventListener('click', (e)=>{
    const el = e.target.closest('.tab');
    if(!el) return;
    setActiveTab(el.dataset.tab);
  });

  // theme toggle in settings
  document.getElementById('themeToggleInSettings').addEventListener('click', ()=>{
    setTheme(state.theme === 'dark' ? 'light' : 'dark');
  });

  // poster settings
  const posterList = document.getElementById('posterList');
  const posterIntervalInput = document.getElementById('posterInterval');
  const addPosterBtn = document.getElementById('addPosterBtn');
  const posterUrlInput = document.getElementById('posterUrl');

  posterIntervalInput.addEventListener('change', ()=>{
    const v = Math.max(1, Number(posterIntervalInput.value) || 6);
    state.posterIntervalSec = v;
    state.posterCountdown = v;
  });

  addPosterBtn.addEventListener('click', ()=>{
    const url = posterUrlInput.value.trim();
    if(!url) return;
    state.posters.push(url);
    posterUrlInput.value = '';
    renderSettingsLists();
  });

  // magnet colors (type)
  const colorName = document.getElementById('colorName');
  const colorCar  = document.getElementById('colorCar');
  const colorDest = document.getElementById('colorDest');
  function syncColorInputs(){
    colorName.value = state.typeColors.name;
    colorCar.value  = state.typeColors.car;
    colorDest.value = state.typeColors.dest;
  }
  colorName.addEventListener('input', ()=>{ state.typeColors.name = colorName.value; renderMagnets(); renderTable(); });
  colorCar.addEventListener('input',  ()=>{ state.typeColors.car  = colorCar.value;  renderMagnets(); renderTable(); });
  colorDest.addEventListener('input', ()=>{ state.typeColors.dest = colorDest.value; renderMagnets(); renderTable(); });

  // magnet add (per-item color)
  const addMagBtn = document.getElementById('addMagBtn');
  const magValueInput = document.getElementById('magValue');
  const magTypeSelect = document.getElementById('magType');
  const magColorInput = document.getElementById('magColor');
  const magList = document.getElementById('magList');

  function syncMagColorDefault(){
    const t = magTypeSelect.value;
    magColorInput.value = state.typeColors[t] || '#EEF2F7';
  }
  magTypeSelect.addEventListener('change', syncMagColorDefault);

  addMagBtn.addEventListener('click', ()=>{
    const v = magValueInput.value.trim();
    if(!v) return;
    const type = magTypeSelect.value;
    const col = magColorInput.value || null;
    state.magnets[type].push({label:v, color: col});
    magValueInput.value = '';
    renderMagnets();
    renderSettingsLists();
  });

  function renderSettingsLists(){
    // posters
    posterList.innerHTML = '';
    state.posters.forEach((url, idx)=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:720px;">${escapeHtml(url)}</div>`;
      const rm = document.createElement('div');
      rm.className = 'rm';
      rm.textContent = '削除';
      rm.addEventListener('click', ()=>{
        state.posters.splice(idx,1);
        state.posterIndex = Math.min(state.posterIndex, Math.max(0, state.posters.length-1));
        if(state.posters.length === 0){
          state.posters.push('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80');
        }
        showPoster();
        renderSettingsLists();
      });
      item.appendChild(rm);
      posterList.appendChild(item);
    });

    // magnets list
    magList.innerHTML = '';
    [['name','名前'],['car','車'],['dest','行先']].forEach(([type, label])=>{
      state.magnets[type].forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'list-item';

        const left = document.createElement('div');
        left.style.display='flex';
        left.style.gap='10px';
        left.style.alignItems='center';
        left.innerHTML = `<span class="pill" style="padding:8px 10px;">${label}</span><span>${escapeHtml(it.label)}</span>`;

        const right = document.createElement('div');
        right.style.display='flex';
        right.style.gap='10px';
        right.style.alignItems='center';

        const c = document.createElement('input');
        c.type = 'color';
        c.value = it.color || state.typeColors[type];
        c.title = '色';
        c.addEventListener('input', ()=>{
          it.color = c.value;
          renderMagnets();
          renderTable();
        });

        const rm = document.createElement('div');
        rm.className = 'rm';
        rm.textContent = '削除';
        rm.addEventListener('click', ()=>{
          state.magnets[type].splice(idx,1);
          renderMagnets();
          renderSettingsLists();
        });

        right.appendChild(c);
        right.appendChild(rm);

        row.appendChild(left);
        row.appendChild(right);
        magList.appendChild(row);
      });
    });

    syncColorInputs();
    syncMagColorDefault();
  }

  // ---- Popover ----
  const pop = document.getElementById('popover');

  function closePopover(){
    pop.style.display = 'none';
    pop.innerHTML = '';
  }
  window.addEventListener('click', (e)=>{
    if(backdrop.classList.contains('open')) return;
    if(pop.style.display === 'none') return;
    if(!pop.contains(e.target)) closePopover();
  });
  window.addEventListener('resize', closePopover);
  window.addEventListener('scroll', closePopover, true);

  function placePopoverNearRect(rect){
    const pad = 12;
    let left = rect.right + 10;
    let top  = rect.top;

    pop.style.display = 'block';
    pop.style.left = '0px';
    pop.style.top = '0px';
    pop.style.visibility = 'hidden';

    const w = pop.offsetWidth;
    const h = pop.offsetHeight;

    const vw = window.innerWidth;
    const vh = window.innerHeight;

    if(left + w + pad > vw) left = rect.left - w - 10;
    if(left < pad) left = pad;

    if(top + h + pad > vh) top = vh - h - pad;
    if(top < pad) top = pad;

    pop.style.left = `${left}px`;
    pop.style.top = `${top}px`;
    pop.style.visibility = 'visible';
  }

  function openTimePopover(rowIndex, rect){
    pop.innerHTML = `
      <div class="pop-head">
        <div class="h">帰社時間</div>
        <button class="icon-btn" id="popClose">×</button>
      </div>
      <div class="pop-body">
        <div class="pick-grid" id="timeGrid"></div>
        <div class="row">
          <button class="btn" id="clearTime">クリア</button>
        </div>
      </div>
    `;
    pop.querySelector('#popClose').addEventListener('click', closePopover);

    const grid = pop.querySelector('#timeGrid');
    const times = [];
    for(let h=8; h<=20; h++){
      times.push(`${String(h).padStart(2,'0')}:00`);
      if(h!==20) times.push(`${String(h).padStart(2,'0')}:30`);
    }
    times.forEach(t=>{
      const btn = document.createElement('div');
      btn.className = 'pick';
      btn.textContent = t;
      btn.addEventListener('click', ()=>{
        state.rows[rowIndex].time = t;
        renderTable();
        closePopover();
      });
      grid.appendChild(btn);
    });

    pop.querySelector('#clearTime').addEventListener('click', ()=>{
      state.rows[rowIndex].time = '';
      renderTable();
      closePopover();
    });

    placePopoverNearRect(rect);
  }

  function openSelectPopover(rowIndex, key, rect){
    const title = key === 'name' ? '氏名' : '行先';
    const list = key === 'name'
      ? state.magnets.name.map(v=>({type:'name',label:v.label,color:v.color}))
      : [
          ...state.magnets.dest.map(v=>({type:'dest',label:v.label,color:v.color})),
          ...state.magnets.car.map(v=>({type:'car',label:v.label,color:v.color}))
        ];

    pop.innerHTML = `
      <div class="pop-head">
        <div class="h">${title}</div>
        <button class="icon-btn" id="popClose">×</button>
      </div>
      <div class="pop-body">
        <div class="pick-grid" id="pickGrid"></div>

        <div class="muted">カスタム指定</div>
        <div class="row">
          <input type="text" id="customText" placeholder="自由入力" />
          <button class="btn primary" id="addCustom">追加</button>
        </div>

        <div class="row">
          <button class="btn" id="clearAll">クリア</button>
        </div>
      </div>
    `;

    pop.querySelector('#popClose').addEventListener('click', closePopover);

    const grid = pop.querySelector('#pickGrid');
    list.slice(0, 12).forEach(item=>{
      const b = document.createElement('div');
      b.className = 'pick';
      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = item.color || state.typeColors[item.type] || '#EEF2F7';
      const t = document.createElement('span');
      t.style.fontWeight = '950';
      t.textContent = item.label;
      b.appendChild(sw);
      b.appendChild(t);

      b.addEventListener('click', ()=>{
        state.rows[rowIndex][key].push({type:item.type, label:item.label, color:item.color || null});
        renderTable();
      });
      grid.appendChild(b);
    });

    pop.querySelector('#addCustom').addEventListener('click', ()=>{
      const v = pop.querySelector('#customText').value.trim();
      if(!v) return;
      state.rows[rowIndex][key].push({type:'custom', label:v, color:null});
      renderTable();
      closePopover();
    });

    pop.querySelector('#clearAll').addEventListener('click', ()=>{
      state.rows[rowIndex][key] = [];
      renderTable();
      closePopover();
    });

    placePopoverNearRect(rect);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // ---- init ----
  setTheme('light');
  renderTable();
  renderMagnets();

})();
</script>
</body>
</html>
