<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>行動予定表（デモ）</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --panel2:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --accent:#2563eb;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --panel:#121a2a;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#253047;
      --shadow: 0 16px 46px rgba(0,0,0,.42);
      --accent:#60a5fa;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", Arial;
      overflow:hidden;
    }

    /* 1920x1080 base (auto scale) */
    .stage-wrap{
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:8px;
    }
    .stage{
      width:1920px; height:1080px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      display:flex; flex-direction:column;
      box-shadow:var(--shadow);
      transform-origin:center center;
    }
    @media (max-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vw - 16px)/1920)); }
    }
    @media (min-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vh - 16px)/1080)); }
    }

    header{
      height:92px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel2), var(--bg));
    }
    .title{
      font-size:34px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .clock{
      font-size:22px;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      font-weight:850;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active{ transform:scale(.98); }
    .btn.primary{
      background:var(--accent);
      border-color:transparent;
      color:#fff;
    }

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr; /* 左:表 / 右:情報 */
      gap:14px;
      padding:14px;
      min-height:0;
    }
    .panel{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      min-height:0;
    }

    /* Left: Table */
    .left{ display:flex; flex-direction:column; min-height:0; }
    .table-wrap{ flex:1; overflow:auto; }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:22px;
    }
    thead th{
      text-align:left;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      font-size:22px;
      font-weight:950;
      border-right:1px solid var(--border);
    }
    thead th:last-child{ border-right:none; }
    tbody td{
      border-bottom:1px solid var(--border);
      border-right:1px solid var(--border);
      padding:10px 12px;
      height:74px;
      vertical-align:middle;
      position:relative;
    }
    tbody td:last-child{ border-right:none; }
    tbody tr:last-child td{ border-bottom:none; }

    .col-name{ width:26%; }
    .col-dest{ width:54%; }
    .col-time{ width:20%; }

    .cell{
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      overflow:hidden;
    }

    /* Square chips in cells */
    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      font-weight:950;
      font-size:20px;
      border:1px solid color-mix(in srgb, var(--text) 14%, transparent);
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      user-select:none;
      cursor:pointer;
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip.time{ cursor:default; }
    .chip:hover{ filter:brightness(0.98); }

    /* Right: Info Zone */
    .right{
      display:flex;
      flex-direction:column;
      min-height:0;
      gap:14px;
    }
    .ads{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .ads-row{
      flex:1;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      padding:12px;
      min-height:0;
    }
    .ad-card{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:linear-gradient(135deg,
        color-mix(in srgb, var(--panel) 80%, transparent),
        color-mix(in srgb, var(--panel2) 80%, transparent)
      );
      min-height:0;
      cursor:pointer;
      user-select:none;
    }
    .ad-card img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .info{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .info-inner{
      height:100%;
      padding:26px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:14px;
      background:
        radial-gradient(900px 500px at 30% 30%,
          color-mix(in srgb, var(--accent) 10%, transparent),
          transparent 60%),
        linear-gradient(180deg, var(--panel2), var(--bg));
    }
    .info-title{
      font-size:28px;
      font-weight:950;
      letter-spacing:.02em;
      color:var(--muted);
    }
    .info-text{
      font-size:54px;
      font-weight:950;
      line-height:1.25;
      letter-spacing:.01em;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* Popover picker */
    .popover{
      position:fixed;
      z-index:1100;
      width:880px;
      max-width: calc(100vw - 24px);
      max-height: calc(100vh - 24px);
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }
    .pop-head{
      padding:14px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .pop-head .h{
      font-weight:950;
      font-size:18px;
    }
    .icon-btn{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
    }
    .pop-body{
      display:grid;
      grid-template-columns: 1fr 56px; /* list + kana index */
      gap:0;
      min-height:0;
      height:560px;
    }
    .pop-main{
      display:flex;
      flex-direction:column;
      min-height:0;
      padding:14px;
      gap:12px;
    }
    .search-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    input[type="text"]{
      width:100%;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      font-weight:750;
      outline:none;
    }
    .mini{
      font-size:14px;
      color:var(--muted);
      font-weight:850;
    }

    .list{
      flex:1;
      min-height:0;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
      background: color-mix(in srgb, var(--panel) 55%, transparent);
    }
    .group{
      padding:10px 12px 14px;
      border-bottom:1px solid var(--border);
    }
    .group:last-child{ border-bottom:none; }
    .group-title{
      position:sticky;
      top:0;
      background: color-mix(in srgb, var(--panel2) 86%, transparent);
      backdrop-filter: blur(6px);
      border:1px solid color-mix(in srgb, var(--border) 65%, transparent);
      border-radius:12px;
      padding:8px 10px;
      font-weight:950;
      width:max-content;
      margin:6px 0 10px;
    }
    .items{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .pick{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:14px;
      padding:12px;
      font-weight:950;
      font-size:18px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:10px;
      min-height:56px;
    }
    .pick:active{ transform:scale(.99); }
    .swatch{
      width:18px; height:18px;
      border-radius:6px;
      border:1px solid color-mix(in srgb, var(--text) 18%, transparent);
      flex:0 0 auto;
    }
    .pick-text{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .pick-text .label{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pick-text .yomi{
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .kana{
      border-left:1px solid var(--border);
      background: color-mix(in srgb, var(--panel) 55%, transparent);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      padding:12px 8px;
    }
    .kana a{
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      text-decoration:none;
      font-weight:950;
      user-select:none;
      cursor:pointer;
    }
    .kana a:active{ transform:scale(.98); }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      padding:14px;
      border-top:1px solid var(--border);
      background:var(--panel2);
    }
    .btn.danger{
      border-color: color-mix(in srgb, #ef4444 45%, var(--border));
      background: color-mix(in srgb, #ef4444 10%, transparent);
      color: #ef4444;
    }

    /* Settings (tabs) */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      z-index:1200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .backdrop.open{ display:flex; }
    .modal{
      width: 1100px;
      max-width: 100%;
      max-height: 92vh;
      overflow:hidden;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
    }
    .modal-head .h{ font-size:20px; font-weight:950; }
    .tabs{
      display:flex;
      gap:8px;
      padding:10px 12px 12px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
    }
    .tab{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: color-mix(in srgb, var(--accent) 14%, var(--panel));
      border-color: color-mix(in srgb, var(--accent) 35%, var(--border));
    }
    .modal-body{
      padding:16px;
      overflow:auto;
    }
    .section{ display:none; }
    .section.active{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card h3{ margin:0; font-size:18px; font-weight:950; }
    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      font-size:16px;
      font-weight:750;
      outline:none;
      line-height:1.5;
    }
    input[type="number"]{
      width:160px;
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      font-size:16px;
      font-weight:750;
      outline:none;
    }
    .list2{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .list-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:14px;
      padding:10px 12px;
      font-weight:850;
    }
    .rm{
      cursor:pointer;
      font-weight:950;
      color:#ef4444;
      border:1px solid color-mix(in srgb, #ef4444 40%, transparent);
      background: color-mix(in srgb, #ef4444 10%, transparent);
      padding:6px 10px;
      border-radius:12px;
      user-select:none;
      flex:0 0 auto;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:999px;
      padding:10px 12px;
      font-weight:850;
    }
    input[type="color"]{
      width:52px; height:42px;
      border:1px solid var(--border);
      background:transparent;
      border-radius:12px;
      padding:4px;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="stage-wrap">
  <div class="stage" id="stage" data-theme="light">
    <header>
      <div class="title">行動予定表</div>
      <div class="header-right">
        <div class="clock" id="clock">--</div>
        <button class="btn primary" id="openSettingsBtn">設定</button>
      </div>
    </header>

    <div class="main">
      <!-- LEFT -->
      <section class="panel left">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="col-name">氏名</th>
                <th class="col-dest">行先</th>
                <th class="col-time">帰社時間</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="right">
        <div class="panel ads" id="adsPanel" title="設定を開く">
          <div class="ads-row" id="adsRow"></div>
        </div>

        <div class="panel info">
          <div class="info-inner">
            <div class="info-title" id="infoTitle">作業の注意</div>
            <div class="info-text" id="infoText"></div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Picker Popover -->
<div class="popover" id="picker"></div>

<!-- Settings Modal -->
<div class="backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-label="設定">
    <div class="modal-head">
      <div class="h">設定</div>
      <button class="btn primary" id="closeSettingsBtn">閉じる</button>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="display">表示</div>
      <div class="tab" data-tab="ads">広告</div>
      <div class="tab" data-tab="items">項目（読み方）</div>
      <div class="tab" data-tab="info">情報表示</div>
    </div>

    <div class="modal-body">
      <!-- 表示 -->
      <div class="section active" id="tab-display">
        <div class="card">
          <h3>テーマ</h3>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div class="pill">ダークモード</div>
            <button class="btn" id="themeToggleInSettings">ダークに切替</button>
          </div>
        </div>

        <div class="card">
          <h3>チップ色</h3>
          <div style="display:flex; flex-wrap:wrap; gap:14px;">
            <div class="pill">名前 <input type="color" id="colorName" /></div>
            <div class="pill">車 <input type="color" id="colorCar" /></div>
            <div class="pill">行先 <input type="color" id="colorDest" /></div>
          </div>
        </div>
      </div>

      <!-- 広告 -->
      <div class="section" id="tab-ads">
        <div class="card">
          <h3>切替</h3>
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="pill">切替(秒)</div>
            <input type="number" id="adsInterval" min="1" value="6" />
          </div>
          <div class="mini">上段の広告カード3枚が、登録URLから順に自動で切り替わります（デモ仕様）。</div>
        </div>

        <div class="card">
          <h3>広告画像URL</h3>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="adUrl" placeholder="画像URLを追加" />
            <button class="btn primary" id="addAdBtn">追加</button>
          </div>
          <div class="list2" id="adList"></div>
        </div>
      </div>

      <!-- 項目（読み方） -->
      <div class="section" id="tab-items">
        <div class="card">
          <h3>追加</h3>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="itemLabel" placeholder="表示（例: 田中 / 1234 / 白ジムニー / 新宿）" />
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="itemYomi" placeholder="読み方（例: たなか / いちにさんよん / しろじむにー / しんじゅく）" />
          </div>
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="itemType" class="btn" style="padding:12px 14px;">
              <option value="name">名前</option>
              <option value="car">車</option>
              <option value="dest">行先</option>
            </select>
            <input type="color" id="itemColor" title="個別色" />
            <button class="btn primary" id="addItemBtn">追加</button>
          </div>
          <div class="mini">読み方の先頭で「あ/か/さ…」に分類され、選択ポップアップの索引ジャンプが効きます。</div>
        </div>

        <div class="card">
          <h3>一覧</h3>
          <div class="list2" id="itemList"></div>
        </div>
      </div>

      <!-- 情報表示 -->
      <div class="section" id="tab-info">
        <div class="card">
          <h3>タイトル</h3>
          <input type="text" id="infoTitleInput" />
          <h3 style="margin-top:6px;">本文</h3>
          <textarea id="infoTextInput"></textarea>
          <button class="btn primary" id="applyInfoBtn">反映</button>
        </div>

        <div class="card">
          <h3>（予約枠）</h3>
          <div class="mini">将来的に「今日の予定」「天気」「安全標語」などの拡張も入れられます。</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const stage = document.getElementById('stage');

  // --------- Utilities ---------
  const pad2 = n => String(n).padStart(2,'0');
  const jpDow = ['日','月','火','水','木','金','土'];

  // ひらがな・カタカナをざっくり正規化（デモ用）
  function toHiragana(str){
    return (str || '').trim().replace(/[\u30A1-\u30F6]/g, ch =>
      String.fromCharCode(ch.charCodeAt(0) - 0x60)
    );
  }
  function headKanaGroup(yomi){
    const s = toHiragana(yomi || '').trim();
    const c = s[0] || '';
    const groups = [
      {k:'あ', re:/^[ぁ-お]/},
      {k:'か', re:/^[か-ご]/},
      {k:'さ', re:/^[さ-ぞ]/},
      {k:'た', re:/^[た-ど]/},
      {k:'な', re:/^[な-の]/},
      {k:'は', re:/^[は-ぽ]/},
      {k:'ま', re:/^[ま-も]/},
      {k:'や', re:/^[ゃ-よ]/},
      {k:'ら', re:/^[ら-ろ]/},
      {k:'わ', re:/^[ゎ-ん]/},
    ];
    const hit = groups.find(g => g.re.test(c));
    return hit ? hit.k : '#';
  }
  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // --------- State ---------
  const state = {
    theme:'light',
    typeColors:{
      name:'#E8F0FF',
      car:'#EAF7EF',
      dest:'#FFF2E7',
      custom:'#EEF2F7',
      time:'#F3F4F6'
    },

    items:{
      name:[
        {label:'田中', yomi:'たなか', color:null},
        {label:'佐藤', yomi:'さとう', color:null},
        {label:'鈴木', yomi:'すずき', color:null},
        {label:'高橋', yomi:'たかはし', color:null},
        {label:'伊藤', yomi:'いとう', color:null},
        {label:'渡辺', yomi:'わたなべ', color:null},
      ],
      car:[
        {label:'1234', yomi:'いちにさんよん', color:null},
        {label:'5678', yomi:'ごーろくななはち', color:null},
        {label:'白ジムニー', yomi:'しろじむにー', color:null},
        {label:'黒ハイエース', yomi:'くろはいえーす', color:null},
      ],
      dest:[
        {label:'新宿', yomi:'しんじゅく', color:null},
        {label:'渋谷', yomi:'しぶや', color:null},
        {label:'品川', yomi:'しながわ', color:null},
        {label:'現場A', yomi:'げんばえー', color:null},
        {label:'倉庫', yomi:'そうこ', color:null},
      ]
    },

    rows:[
      { name:[{type:'name', label:'田中', yomi:'たなか', color:null}],
        dest:[{type:'dest', label:'新宿', yomi:'しんじゅく', color:null}, {type:'car', label:'1234', yomi:'いちにさんよん', color:null}],
        time:'16:30' },
      { name:[{type:'name', label:'佐藤', yomi:'さとう', color:null}],
        dest:[{type:'dest', label:'現場A', yomi:'げんばえー', color:null}],
        time:'15:00' },
      { name:[{type:'name', label:'鈴木', yomi:'すずき', color:null}],
        dest:[{type:'car', label:'白ジムニー', yomi:'しろじむにー', color:null}, {type:'dest', label:'渋谷', yomi:'しぶや', color:null}],
        time:'' },
      ...Array.from({length:9}).map(()=>({name:[],dest:[],time:''}))
    ],

    ads:[
      'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1525182008055-f88b95ff7980?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1553877522-43269d4ea984?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1520607162513-77705c0f0d4a?auto=format&fit=crop&w=1600&q=80'
    ],
    adsIntervalSec:6,
    adsIndex:0,
    adsCountdown:6,

    infoTitle:'作業の注意',
    infoText:'安全第一\n足元注意\n立入禁止区域の確認'
  };

  // --------- Clock ---------
  const clockEl = document.getElementById('clock');
  function tickClock(){
    const d = new Date();
    clockEl.textContent = `${d.getMonth()+1}月${d.getDate()}日（${jpDow[d.getDay()]}） ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  tickClock();
  setInterval(tickClock, 1000);

  // --------- Theme ---------
  function setTheme(next){
    state.theme = next;
    stage.setAttribute('data-theme', next);
    document.getElementById('themeToggleInSettings').textContent =
      next === 'dark' ? 'ライトに切替' : 'ダークに切替';
  }

  // --------- Info render ---------
  const infoTitleEl = document.getElementById('infoTitle');
  const infoTextEl  = document.getElementById('infoText');
  function renderInfo(){
    infoTitleEl.textContent = state.infoTitle;
    infoTextEl.textContent  = state.infoText;
  }
  renderInfo();

  // --------- Ads render (3 cards, rotating) ---------
  const adsRow = document.getElementById('adsRow');
  function renderAds(){
    adsRow.innerHTML = '';
    const total = state.ads.length || 1;
    for(let i=0;i<3;i++){
      const idx = (state.adsIndex + i) % total;
      const card = document.createElement('div');
      card.className = 'ad-card';
      const img = document.createElement('img');
      img.src = state.ads[idx] || '';
      img.alt = 'ad';
      card.appendChild(img);
      adsRow.appendChild(card);
    }
  }
  function adsTick(){
    state.adsCountdown -= 1;
    if(state.adsCountdown <= 0){
      state.adsIndex = (state.adsIndex + 1) % Math.max(state.ads.length, 1);
      state.adsCountdown = Math.max(1, Number(state.adsIntervalSec) || 6);
      renderAds();
    }
  }
  renderAds();
  setInterval(adsTick, 1000);

  // --------- Table ---------
  const tbody = document.getElementById('tbody');

  function chipBg(chip){
    return chip.color || state.typeColors[chip.type] || '#EEF2F7';
  }
  function makeChip(chip, rowIndex, key, index){
    const el = document.createElement('div');
    el.className = 'chip' + (chip.type === 'time' ? ' time' : '');
    el.style.background = chipBg(chip);
    el.textContent = chip.label;

    // chip単体削除（ポップアップで）
    if(chip.type !== 'time'){
      el.title = 'クリックで削除';
      el.addEventListener('click', (e)=>{
        e.stopPropagation();
        state.rows[rowIndex][key].splice(index,1);
        renderTable();
      });
    }
    return el;
  }

  function renderCell(cellDiv, rowIndex, key){
    cellDiv.innerHTML = '';
    if(key === 'time'){
      const v = state.rows[rowIndex].time;
      if(!v){ return; }
      const chip = document.createElement('div');
      chip.className = 'chip time';
      chip.style.background = state.typeColors.time;
      chip.textContent = v;
      cellDiv.appendChild(chip);
      return;
    }

    const arr = state.rows[rowIndex][key] || [];
    arr.forEach((c, idx)=> cellDiv.appendChild(makeChip(c,rowIndex,key,idx)));
  }

  function makeTd(rowIndex, key){
    const td = document.createElement('td');
    const cell = document.createElement('div');
    cell.className = 'cell';
    td.appendChild(cell);

    td.addEventListener('click', (e)=>{
      e.stopPropagation();
      const rect = td.getBoundingClientRect();
      if(key === 'time') openTimePicker(rowIndex, rect);
      else openItemPicker(rowIndex, key, rect);
    });

    renderCell(cell, rowIndex, key);
    return td;
  }

  function renderTable(){
    tbody.innerHTML = '';
    state.rows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.appendChild(makeTd(i,'name'));
      tr.appendChild(makeTd(i,'dest'));
      tr.appendChild(makeTd(i,'time'));
      tbody.appendChild(tr);
    });
  }
  renderTable();

  // --------- Picker (kana index + search) ---------
  const picker = document.getElementById('picker');

  function closePicker(){
    picker.style.display = 'none';
    picker.innerHTML = '';
  }
  window.addEventListener('click', (e)=>{
    if(document.getElementById('backdrop').classList.contains('open')) return;
    if(picker.style.display === 'none') return;
    if(!picker.contains(e.target)) closePicker();
  });
  window.addEventListener('resize', closePicker);
  window.addEventListener('scroll', closePicker, true);

  function placePickerNearRect(rect){
    const pad = 12;

    picker.style.display = 'block';
    picker.style.left = '0px';
    picker.style.top = '0px';
    picker.style.visibility = 'hidden';

    const w = picker.offsetWidth;
    const h = picker.offsetHeight;
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    let left = rect.left + (rect.width/2) - (w/2);
    let top  = rect.top + (rect.height/2) - (h/2);

    if(left < pad) left = pad;
    if(left + w + pad > vw) left = vw - w - pad;
    if(top < pad) top = pad;
    if(top + h + pad > vh) top = vh - h - pad;

    picker.style.left = `${left}px`;
    picker.style.top  = `${top}px`;
    picker.style.visibility = 'visible';
  }

  function buildGroups(items){
    const groupsOrder = ['あ','か','さ','た','な','は','ま','や','ら','わ','#'];
    const map = new Map(groupsOrder.map(k => [k, []]));
    items.forEach(it => {
      const g = headKanaGroup(it.yomi);
      if(!map.has(g)) map.set(g, []);
      map.get(g).push(it);
    });
    // sort within group by yomi
    groupsOrder.forEach(k => {
      map.get(k).sort((a,b)=> (toHiragana(a.yomi)||'').localeCompare(toHiragana(b.yomi)||''));
    });
    return {groupsOrder, map};
  }

  function openItemPicker(rowIndex, key, rect){
    // key=name -> name items
    // key=dest -> dest + car items (両方置ける)
    let source = [];
    if(key === 'name'){
      source = state.items.name.map(x => ({...x, type:'name'}));
    } else {
      source = [
        ...state.items.dest.map(x => ({...x, type:'dest'})),
        ...state.items.car.map(x => ({...x, type:'car'}))
      ];
    }

    const title = key === 'name' ? '氏名' : '行先';
    picker.innerHTML = `
      <div class="pop-head">
        <div class="h">${title}</div>
        <button class="icon-btn" id="pickClose">×</button>
      </div>

      <div class="pop-body">
        <div class="pop-main">
          <div class="search-row">
            <input type="text" id="q" placeholder="検索（表示 / 読み方）" />
            <button class="btn" id="clearCell">クリア</button>
          </div>
          <div class="list" id="list"></div>

          <div class="mini">カスタム指定（OSキーボード）</div>
          <div class="search-row">
            <input type="text" id="custom" placeholder="自由入力" />
            <button class="btn primary" id="addCustom">追加</button>
          </div>
        </div>

        <div class="kana" id="kana"></div>
      </div>

      <div class="actions">
        <button class="btn danger" id="clearAll">全削除</button>
        <button class="btn primary" id="done">閉じる</button>
      </div>
    `;

    picker.querySelector('#pickClose').addEventListener('click', closePicker);
    picker.querySelector('#done').addEventListener('click', closePicker);

    const listEl = picker.querySelector('#list');
    const kanaEl = picker.querySelector('#kana');
    const qEl = picker.querySelector('#q');

    function renderList(){
      const q = (qEl.value || '').trim();
      const filtered = source.filter(it => {
        if(!q) return true;
        const hay = `${it.label} ${it.yomi}`.toLowerCase();
        return hay.includes(q.toLowerCase());
      });

      const {groupsOrder, map} = buildGroups(filtered);

      listEl.innerHTML = '';
      groupsOrder.forEach(k => {
        const arr = map.get(k);
        if(!arr || arr.length === 0) return;

        const group = document.createElement('div');
        group.className = 'group';
        group.id = `g-${k}`;

        const gt = document.createElement('div');
        gt.className = 'group-title';
        gt.textContent = k;
        group.appendChild(gt);

        const items = document.createElement('div');
        items.className = 'items';

        arr.forEach(it => {
          const p = document.createElement('div');
          p.className = 'pick';

          const sw = document.createElement('span');
          sw.className = 'swatch';
          sw.style.background = it.color || state.typeColors[it.type] || '#EEF2F7';

          const t = document.createElement('div');
          t.className = 'pick-text';
          t.innerHTML = `<div class="label">${escapeHtml(it.label)}</div><div class="yomi">${escapeHtml(it.yomi || '')}</div>`;

          p.appendChild(sw);
          p.appendChild(t);

          p.addEventListener('click', ()=>{
            state.rows[rowIndex][key].push({
              type: it.type,
              label: it.label,
              yomi: it.yomi || '',
              color: it.color || null
            });
            renderTable();
          });

          items.appendChild(p);
        });

        group.appendChild(items);
        listEl.appendChild(group);
      });

      // kana index
      const kanaKeys = ['あ','か','さ','た','な','は','ま','や','ら','わ','#'];
      kanaEl.innerHTML = '';
      kanaKeys.forEach(k => {
        const a = document.createElement('a');
        a.textContent = k;
        a.addEventListener('click', ()=>{
          const target = listEl.querySelector(`#g-${CSS.escape(k)}`);
          if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        });
        kanaEl.appendChild(a);
      });
    }

    qEl.addEventListener('input', renderList);
    picker.querySelector('#clearCell').addEventListener('click', ()=>{
      state.rows[rowIndex][key] = [];
      renderTable();
      renderList();
    });
    picker.querySelector('#clearAll').addEventListener('click', ()=>{
      state.rows[rowIndex][key] = [];
      renderTable();
      renderList();
    });

    picker.querySelector('#addCustom').addEventListener('click', ()=>{
      const v = (picker.querySelector('#custom').value || '').trim();
      if(!v) return;
      state.rows[rowIndex][key].push({type:'custom', label:v, yomi:'', color:null});
      renderTable();
      picker.querySelector('#custom').value = '';
    });

    renderList();
    placePickerNearRect(rect);
    qEl.focus();
  }

  function openTimePicker(rowIndex, rect){
    picker.innerHTML = `
      <div class="pop-head">
        <div class="h">帰社時間</div>
        <button class="icon-btn" id="pickClose">×</button>
      </div>
      <div class="pop-body" style="grid-template-columns: 1fr;">
        <div class="pop-main" style="padding:14px;">
          <div class="list" id="timeList" style="height:520px;"></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn danger" id="clear">クリア</button>
        <button class="btn primary" id="done">閉じる</button>
      </div>
    `;
    picker.querySelector('#pickClose').addEventListener('click', closePicker);
    picker.querySelector('#done').addEventListener('click', closePicker);

    const timeList = picker.querySelector('#timeList');
    const times = [];
    for(let h=8; h<=20; h++){
      times.push(`${pad2(h)}:00`);
      if(h!==20) times.push(`${pad2(h)}:30`);
    }

    // simple 2-col grid
    const wrap = document.createElement('div');
    wrap.style.display = 'grid';
    wrap.style.gridTemplateColumns = '1fr 1fr';
    wrap.style.gap = '10px';
    wrap.style.padding = '12px';

    times.forEach(t=>{
      const p = document.createElement('div');
      p.className = 'pick';
      p.textContent = t;
      p.addEventListener('click', ()=>{
        state.rows[rowIndex].time = t;
        renderTable();
      });
      wrap.appendChild(p);
    });

    timeList.appendChild(wrap);

    picker.querySelector('#clear').addEventListener('click', ()=>{
      state.rows[rowIndex].time = '';
      renderTable();
    });

    placePickerNearRect(rect);
  }

  // --------- Settings Modal ---------
  const backdrop = document.getElementById('backdrop');
  const openSettingsBtn = document.getElementById('openSettingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const adsPanel = document.getElementById('adsPanel');

  function openSettings(){
    backdrop.classList.add('open');
    syncSettingsUI();
  }
  function closeSettings(){
    backdrop.classList.remove('open');
  }
  openSettingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', closeSettings);
  adsPanel.addEventListener('click', openSettings);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeSettings(); });

  // Tabs
  const tabs = document.getElementById('tabs');
  function setActiveTab(key){
    tabs.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === `tab-${key}`));
  }
  tabs.addEventListener('click', (e)=>{
    const el = e.target.closest('.tab');
    if(!el) return;
    setActiveTab(el.dataset.tab);
  });

  // Theme toggle
  document.getElementById('themeToggleInSettings').addEventListener('click', ()=>{
    setTheme(state.theme === 'dark' ? 'light' : 'dark');
  });

  // Colors
  const colorName = document.getElementById('colorName');
  const colorCar  = document.getElementById('colorCar');
  const colorDest = document.getElementById('colorDest');
  colorName.addEventListener('input', ()=>{ state.typeColors.name = colorName.value; renderTable(); });
  colorCar.addEventListener('input',  ()=>{ state.typeColors.car  = colorCar.value;  renderTable(); });
  colorDest.addEventListener('input', ()=>{ state.typeColors.dest = colorDest.value; renderTable(); });

  // Ads
  const adsInterval = document.getElementById('adsInterval');
  adsInterval.addEventListener('change', ()=>{
    state.adsIntervalSec = Math.max(1, Number(adsInterval.value) || 6);
    state.adsCountdown = state.adsIntervalSec;
  });
  document.getElementById('addAdBtn').addEventListener('click', ()=>{
    const url = (document.getElementById('adUrl').value || '').trim();
    if(!url) return;
    state.ads.push(url);
    document.getElementById('adUrl').value = '';
    renderAds();
    renderAdList();
  });

  const adList = document.getElementById('adList');
  function renderAdList(){
    adList.innerHTML = '';
    state.ads.forEach((url, idx)=>{
      const row = document.createElement('div');
      row.className = 'list-item';
      row.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:740px;">${escapeHtml(url)}</div>`;
      const rm = document.createElement('div');
      rm.className = 'rm';
      rm.textContent = '削除';
      rm.addEventListener('click', ()=>{
        state.ads.splice(idx,1);
        if(state.ads.length === 0){
          state.ads.push('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80');
        }
        state.adsIndex = Math.min(state.adsIndex, state.ads.length-1);
        renderAds();
        renderAdList();
      });
      row.appendChild(rm);
      adList.appendChild(row);
    });
  }

  // Items (label + yomi)
  const itemType = document.getElementById('itemType');
  const itemColor = document.getElementById('itemColor');
  function syncItemColorDefault(){
    itemColor.value = state.typeColors[itemType.value] || '#EEF2F7';
  }
  itemType.addEventListener('change', syncItemColorDefault);

  document.getElementById('addItemBtn').addEventListener('click', ()=>{
    const label = (document.getElementById('itemLabel').value || '').trim();
    const yomi  = (document.getElementById('itemYomi').value  || '').trim();
    const type  = itemType.value;
    if(!label) return;
    state.items[type].push({label, yomi: yomi || '', color: itemColor.value || null});
    document.getElementById('itemLabel').value = '';
    document.getElementById('itemYomi').value = '';
    renderItemList();
  });

  const itemList = document.getElementById('itemList');
  function renderItemList(){
    itemList.innerHTML = '';
    [['name','名前'],['car','車'],['dest','行先']].forEach(([type, label])=>{
      state.items[type].forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = 'list-item';

        const left = document.createElement('div');
        left.style.display='flex';
        left.style.flexDirection='column';
        left.style.gap='2px';
        left.style.minWidth='0';
        left.innerHTML = `
          <div><span class="pill" style="padding:6px 10px; margin-right:8px;">${label}</span>${escapeHtml(it.label)}</div>
          <div class="mini">${escapeHtml(it.yomi || '')}</div>
        `;

        const right = document.createElement('div');
        right.style.display='flex';
        right.style.gap='10px';
        right.style.alignItems='center';

        const c = document.createElement('input');
        c.type = 'color';
        c.value = it.color || state.typeColors[type];
        c.addEventListener('input', ()=>{ it.color = c.value; renderTable(); });

        const rm = document.createElement('div');
        rm.className = 'rm';
        rm.textContent = '削除';
        rm.addEventListener('click', ()=>{
          state.items[type].splice(idx,1);
          renderItemList();
        });

        right.appendChild(c);
        right.appendChild(rm);

        row.appendChild(left);
        row.appendChild(right);
        itemList.appendChild(row);
      });
    });
  }

  // Info edit
  const infoTitleInput = document.getElementById('infoTitleInput');
  const infoTextInput  = document.getElementById('infoTextInput');
  document.getElementById('applyInfoBtn').addEventListener('click', ()=>{
    state.infoTitle = (infoTitleInput.value || '').trim() || '作業の注意';
    state.infoText  = (infoTextInput.value || '').trim();
    renderInfo();
  });

  function syncSettingsUI(){
    // theme
    document.getElementById('themeToggleInSettings').textContent =
      state.theme === 'dark' ? 'ライトに切替' : 'ダークに切替';

    // colors
    colorName.value = state.typeColors.name;
    colorCar.value  = state.typeColors.car;
    colorDest.value = state.typeColors.dest;

    // ads
    adsInterval.value = state.adsIntervalSec;
    renderAdList();

    // items
    syncItemColorDefault();
    renderItemList();

    // info
    infoTitleInput.value = state.infoTitle;
    infoTextInput.value  = state.infoText;
  }

  // init
  setTheme('light');
  renderAdList();
  renderItemList();
})();
</script>
</body>
</html>
