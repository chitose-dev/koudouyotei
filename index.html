<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>行動予定表（デモ）</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --panel2:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --accent:#2563eb;
      --chip:#eef2ff;
      --chipText:#1e3a8a;
      --danger:#ef4444;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --panel:#121a2a;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#253047;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#60a5fa;
      --chip:#1f2a44;
      --chipText:#dbeafe;
      --danger:#fb7185;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", Arial;
      overflow:hidden; /* サイネージ想定 */
    }

    /* --- 1920x1080 想定を保ちつつ縮小対応 --- */
    .stage-wrap{
      width:100vw;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
    }
    .stage{
      width:1920px;
      height:1080px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow: var(--shadow);
      transform-origin: center center;
    }
    @media (max-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vw - 16px)/1920)); }
    }
    @media (min-aspect-ratio: 16/9){
      .stage{ transform: scale(calc((100vh - 16px)/1080)); }
    }

    /* --- Header --- */
    header{
      height:92px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel2), var(--bg));
    }
    .title{
      font-size:34px;
      font-weight:800;
      letter-spacing:.02em;
    }
    .header-right{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .clock{
      font-size:22px;
      color:var(--muted);
      font-weight:600;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background:var(--accent);
      border-color:transparent;
      color:white;
    }

    /* --- Main Layout --- */
    .main{
      flex:1;
      display:flex;
      gap:14px;
      padding:14px;
      min-height:0;
    }
    .left{
      flex: 0 0 70%;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right{
      flex: 0 0 30%;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
      min-height:0;
    }
    .panel{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
      min-height:0;
    }

    /* --- Table --- */
    .table-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
    }
    .table-head .sub{
      color:var(--muted);
      font-weight:700;
      font-size:16px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:22px;
    }
    thead th{
      text-align:left;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      font-size:22px;
      font-weight:900;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 12px;
      height:74px;
      vertical-align:middle;
      position:relative;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .col-name{ width:26%; }
    .col-dest{ width:54%; }
    .col-time{ width:20%; }

    .cell{
      height:100%;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      overflow:hidden;
    }
    .cell.placeholder{
      color:var(--muted);
      font-weight:700;
    }
    .droppable{
      outline: 2px dashed transparent;
      outline-offset: -6px;
      border-radius:12px;
    }
    .droppable.drag-over{
      outline-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }

    /* --- Chips (dropped magnets) --- */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:var(--chip);
      color:var(--chipText);
      font-weight:900;
      font-size:20px;
      border:1px solid color-mix(in srgb, var(--chipText) 20%, transparent);
      max-width:100%;
    }
    .chip small{
      font-size:16px;
      font-weight:800;
      opacity:.9;
    }
    .chip .x{
      margin-left:2px;
      font-size:18px;
      font-weight:900;
      opacity:.8;
      cursor:pointer;
      user-select:none;
    }
    .chip .x:hover{ opacity:1; }

    /* --- Right: Poster --- */
    .poster{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .poster-top{
      padding:12px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .poster-top .label{
      font-weight:900;
      font-size:20px;
    }
    .poster-top .hint{
      color:var(--muted);
      font-weight:800;
      font-size:14px;
    }
    .poster-zone{
      flex:1;
      position:relative;
      cursor:pointer;
      user-select:none;
      background: linear-gradient(135deg,
        color-mix(in srgb, var(--panel) 80%, transparent),
        color-mix(in srgb, var(--panel2) 80%, transparent)
      );
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:0;
    }
    .poster-zone img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .poster-overlay{
      position:absolute;
      right:12px;
      bottom:12px;
      padding:10px 12px;
      border-radius:999px;
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
      box-shadow: var(--shadow);
      font-size:16px;
    }

    /* --- Right: Magnets --- */
    .magnets{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .magnets-head{
      padding:12px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .magnets-head .label{
      font-weight:900;
      font-size:20px;
    }
    .magnets-body{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:0;
      min-height:0;
    }
    .mag-col{
      border-right:1px solid var(--border);
      padding:12px;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .mag-col:last-child{ border-right:none; }
    .mag-title{
      font-weight:900;
      font-size:18px;
      color:var(--muted);
      letter-spacing:.02em;
    }
    .mag-grid{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      grid-auto-rows: minmax(64px, auto);
      gap:10px;
      align-content:start;
      overflow:auto;
      padding-right:6px;
    }

    .mag{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:16px;
      padding:12px 12px;
      font-weight:950;
      font-size:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:grab;
      user-select:none;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    .mag:active{ cursor:grabbing; transform:scale(.99); }
    .badge{
      font-size:16px;
      font-weight:900;
      color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background: color-mix(in srgb, var(--bg) 70%, transparent);
    }

    /* --- Popovers (cell dialogs) --- */
    .popover{
      position:fixed;
      z-index:1000;
      width:480px;
      max-width: calc(100vw - 24px);
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .pop-head{
      padding:12px 14px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .pop-head .h{
      font-weight:950;
      font-size:18px;
    }
    .icon-btn{
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .pop-body{ padding:14px; display:flex; flex-direction:column; gap:12px; }
    .pick-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .pick{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:14px;
      padding:12px;
      font-weight:950;
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .pick:active{ transform:scale(.99); }
    .muted{ color:var(--muted); font-weight:800; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="text"], input[type="number"]{
      background:var(--panel2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px;
      font-size:16px;
      font-weight:700;
      outline:none;
      width:100%;
    }
    input[type="number"]{ width:140px; }

    /* --- Settings modal --- */
    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      z-index:1200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .backdrop.open{ display:flex; }
    .modal{
      width: 920px;
      max-width: 100%;
      max-height: 92vh;
      overflow:auto;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
    }
    .modal-head{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--panel2);
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal-head .h{
      font-size:20px;
      font-weight:950;
    }
    .modal-body{ padding:16px; display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card h3{
      margin:0;
      font-size:18px;
      font-weight:950;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .list-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--border);
      background:var(--panel2);
      border-radius:14px;
      padding:10px 12px;
      font-weight:850;
    }
    .list-item .rm{
      cursor:pointer;
      font-weight:950;
      color:var(--danger);
      border:1px solid color-mix(in srgb, var(--danger) 40%, transparent);
      background: color-mix(in srgb, var(--danger) 10%, transparent);
      padding:6px 10px;
      border-radius:12px;
      user-select:none;
    }

    .foot-note{
      padding:12px 14px;
      color:var(--muted);
      font-size:14px;
      font-weight:800;
      border-top:1px solid var(--border);
      background:var(--panel);
    }
  </style>
</head>
<body>
  <div class="stage-wrap">
    <div class="stage" id="stage" data-theme="light">
      <header>
        <div class="title">行動予定表</div>
        <div class="header-right">
          <div class="clock" id="clock">--</div>
          <button class="btn" id="themeBtn">ダーク切替</button>
          <button class="btn primary" id="openSettingsBtn">設定</button>
        </div>
      </header>

      <div class="main">
        <!-- LEFT: TABLE -->
        <section class="left">
          <div class="table-head">
            <div class="sub">※デモ：セルをタップで編集 / マグネットをドラッグ＆ドロップで配置</div>
            <div class="sub">タッチパネル想定</div>
          </div>

          <div style="flex:1; overflow:auto;">
            <table id="scheduleTable">
              <thead>
                <tr>
                  <th class="col-name">氏名</th>
                  <th class="col-dest">行先（車も置けます）</th>
                  <th class="col-time">帰社時間</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </section>

        <!-- RIGHT -->
        <aside class="right">
          <!-- Poster -->
          <section class="panel poster">
            <div class="poster-top">
              <div class="label">ポスター</div>
              <div class="hint">クリックで設定</div>
            </div>
            <div class="poster-zone" id="posterZone" title="クリックで設定">
              <img id="posterImg" alt="poster" />
              <div class="poster-overlay" id="posterOverlay">次の切替: <span id="posterCountdown">--</span>s</div>
            </div>
          </section>

          <!-- Magnets -->
          <section class="panel magnets">
            <div class="magnets-head">
              <div class="label">マグネット</div>
              <div class="hint muted">ドラッグして表に配置</div>
            </div>

            <div class="magnets-body">
              <div class="mag-col">
                <div class="mag-title">名前</div>
                <div class="mag-grid" id="magNames"></div>
              </div>
              <div class="mag-col">
                <div class="mag-title">車</div>
                <div class="mag-grid" id="magCars"></div>
              </div>
              <div class="mag-col">
                <div class="mag-title">行先</div>
                <div class="mag-grid" id="magDests"></div>
              </div>
            </div>
          </section>
        </aside>
      </div>

      <div class="foot-note">
        デモ版：データ永続化なし（リロードで初期化）。商談用に動作のみ再現しています。
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-label="設定">
      <div class="modal-head">
        <div class="h">設定（デモ）</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="themeBtn2">テーマ切替</button>
          <button class="btn primary" id="closeSettingsBtn">閉じる</button>
        </div>
      </div>

      <div class="modal-body">
        <div class="card">
          <h3>ポスター設定</h3>
          <div class="row">
            <div class="badge">切替(秒)</div>
            <input type="number" id="posterInterval" min="1" value="6" />
          </div>
          <div class="row">
            <input type="text" id="posterUrl" placeholder="画像URLを追加（例: https://.../poster.jpg）" />
            <button class="btn primary" id="addPosterBtn">追加</button>
          </div>
          <div class="muted">※商談デモ用：URL追加のみ（アップロード未実装）</div>
          <div class="list" id="posterList"></div>
        </div>

        <div class="card">
          <h3>マグネット設定</h3>
          <div class="row">
            <input type="text" id="magValue" placeholder="追加する内容（例: 田中 / 1234 / 白ジムニー / 新宿）" />
            <select id="magType" class="btn" style="padding:12px 14px;">
              <option value="name">名前</option>
              <option value="car">車</option>
              <option value="dest">行先</option>
            </select>
            <button class="btn primary" id="addMagBtn">追加</button>
          </div>
          <div class="muted">※枚数に応じて自動でサイズ調整（grid auto-fit）</div>
          <div class="list" id="magList"></div>
        </div>
      </div>

      <div class="foot-note">
        ポスターゾーンのクリックでもこの設定を開けます。
      </div>
    </div>
  </div>

  <!-- Popover (single instance) -->
  <div class="popover" id="popover" style="display:none;"></div>

<script>
(() => {
  const stage = document.getElementById('stage');
  const clockEl = document.getElementById('clock');

  // ---- Demo state ----
  const state = {
    theme: 'light',
    posters: [
      // ダミー（商談で「差し替えできます」を見せる用）
      'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1525182008055-f88b95ff7980?auto=format&fit=crop&w=1600&q=80',
      'https://images.unsplash.com/photo-1553877522-43269d4ea984?auto=format&fit=crop&w=1600&q=80'
    ],
    posterIntervalSec: 6,
    posterIndex: 0,
    posterCountdown: 6,

    magnets: {
      name: ['田中', '佐藤', '鈴木', '高橋', '伊藤', '渡辺'],
      car: ['1234', '5678', '白ジムニー', '黒ハイエース', '9988'],
      dest: ['新宿', '渋谷', '品川', '現場A', '現場B', '倉庫']
    },

    // table rows: each cell holds chips [{type,label}]
    rows: [
      { name: [{type:'name',label:'田中'}], dest: [{type:'dest',label:'新宿'},{type:'car',label:'1234'}], time: '16:30' },
      { name: [{type:'name',label:'佐藤'}], dest: [{type:'dest',label:'現場A'}], time: '15:00' },
      { name: [{type:'name',label:'鈴木'}], dest: [{type:'car',label:'白ジムニー'},{type:'dest',label:'渋谷'}], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' },
      { name: [], dest: [], time: '' }
    ]
  };

  // ---- Clock ----
  const pad2 = (n)=> String(n).padStart(2,'0');
  const jpDow = ['日','月','火','水','木','金','土'];
  function tickClock(){
    const d = new Date();
    const text = `${d.getMonth()+1}月${d.getDate()}日（${jpDow[d.getDay()]}） ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    clockEl.textContent = text;
  }
  tickClock();
  setInterval(tickClock, 1000);

  // ---- Theme ----
  function setTheme(next){
    state.theme = next;
    stage.setAttribute('data-theme', next);
    document.getElementById('themeBtn').textContent = next === 'dark' ? 'ライト切替' : 'ダーク切替';
  }
  document.getElementById('themeBtn').addEventListener('click', ()=> setTheme(state.theme === 'dark' ? 'light' : 'dark'));
  document.getElementById('themeBtn2').addEventListener('click', ()=> setTheme(state.theme === 'dark' ? 'light' : 'dark'));

  // ---- Table render ----
  const tbody = document.getElementById('tbody');

  function chipEl(chip, onRemove){
    const el = document.createElement('span');
    el.className = 'chip';
    el.innerHTML = `<span>${escapeHtml(chip.label)}</span>`;
    // type small badge
    const small = document.createElement('small');
    small.textContent = chip.type === 'name' ? '名' : chip.type === 'car' ? '車' : chip.type === 'dest' ? '先' : '入';
    el.appendChild(small);

    const x = document.createElement('span');
    x.className = 'x';
    x.textContent = '×';
    x.addEventListener('click', (e)=>{
      e.stopPropagation();
      onRemove?.();
    });
    el.appendChild(x);
    return el;
  }

  function renderCell(cellDiv, rowIndex, key){
    cellDiv.innerHTML = '';
    const data = state.rows[rowIndex][key];
    if(key === 'time'){
      if(data){
        cellDiv.appendChild(chipEl({type:'time',label:data}, ()=>{
          state.rows[rowIndex].time = '';
          renderTable();
        }));
      } else {
        const ph = document.createElement('span');
        ph.className = 'cell placeholder';
        ph.textContent = 'タップして時間';
        cellDiv.appendChild(ph);
      }
      return;
    }

    if(!data || data.length === 0){
      const ph = document.createElement('span');
      ph.className = 'cell placeholder';
      ph.textContent = key === 'name' ? '（空欄）' : '（空欄）';
      cellDiv.appendChild(ph);
      return;
    }
    data.forEach((c, idx)=>{
      cellDiv.appendChild(chipEl(c, ()=>{
        state.rows[rowIndex][key].splice(idx,1);
        renderTable();
      }));
    });
  }

  function makeTd(rowIndex, key){
    const td = document.createElement('td');
    td.classList.add('droppable');
    td.dataset.row = rowIndex;
    td.dataset.key = key;

    const cell = document.createElement('div');
    cell.className = 'cell';
    td.appendChild(cell);

    // Tap to edit popover
    td.addEventListener('click', (e)=>{
      e.stopPropagation();
      const rect = td.getBoundingClientRect();
      if(key === 'time'){
        openTimePopover(rowIndex, rect);
      } else {
        openSelectPopover(rowIndex, key, rect);
      }
    });

    // Drag and drop
    td.addEventListener('dragover', (e)=>{
      e.preventDefault();
      td.classList.add('drag-over');
    });
    td.addEventListener('dragleave', ()=>{
      td.classList.remove('drag-over');
    });
    td.addEventListener('drop', (e)=>{
      e.preventDefault();
      td.classList.remove('drag-over');
      const payload = e.dataTransfer.getData('application/json');
      if(!payload) return;
      const mag = JSON.parse(payload);
      if(key === 'time'){
        // 時間セルにマグネットは入れない（仕様上）
        return;
      }
      // 氏名・行先は複数OK
      state.rows[rowIndex][key].push({type: mag.type, label: mag.label});
      renderTable();
    });

    renderCell(cell, rowIndex, key);
    return td;
  }

  function renderTable(){
    tbody.innerHTML = '';
    state.rows.forEach((r, i)=>{
      const tr = document.createElement('tr');
      tr.appendChild(makeTd(i,'name'));
      tr.appendChild(makeTd(i,'dest'));
      tr.appendChild(makeTd(i,'time'));
      tbody.appendChild(tr);
    });
  }

  // ---- Magnets render ----
  function renderMagnets(){
    const names = document.getElementById('magNames');
    const cars  = document.getElementById('magCars');
    const dests = document.getElementById('magDests');
    names.innerHTML = cars.innerHTML = dests.innerHTML = '';

    function addMag(container, type, label){
      const el = document.createElement('div');
      el.className = 'mag';
      el.draggable = true;
      el.dataset.type = type;
      el.dataset.label = label;

      const t = document.createElement('div');
      t.textContent = label;

      const b = document.createElement('div');
      b.className = 'badge';
      b.textContent = type === 'name' ? '名前' : type === 'car' ? '車' : '行先';

      el.appendChild(t);
      el.appendChild(b);

      el.addEventListener('dragstart', (e)=>{
        e.dataTransfer.effectAllowed = 'copy';
        e.dataTransfer.setData('application/json', JSON.stringify({type, label}));
      });

      container.appendChild(el);
    }

    state.magnets.name.forEach(v=> addMag(names,'name',v));
    state.magnets.car.forEach(v=> addMag(cars,'car',v));
    state.magnets.dest.forEach(v=> addMag(dests,'dest',v));
  }

  // ---- Poster carousel ----
  const posterImg = document.getElementById('posterImg');
  const posterCountdownEl = document.getElementById('posterCountdown');

  function showPoster(){
    const url = state.posters[state.posterIndex] || '';
    posterImg.src = url;
  }
  function posterTick(){
    state.posterCountdown -= 1;
    if(state.posterCountdown <= 0){
      state.posterIndex = (state.posterIndex + 1) % Math.max(state.posters.length, 1);
      state.posterCountdown = Math.max(1, Number(state.posterIntervalSec) || 6);
      showPoster();
    }
    posterCountdownEl.textContent = state.posterCountdown;
  }
  showPoster();
  posterCountdownEl.textContent = state.posterCountdown;
  setInterval(posterTick, 1000);

  // ---- Settings modal ----
  const backdrop = document.getElementById('backdrop');
  const openSettingsBtn = document.getElementById('openSettingsBtn');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const posterZone = document.getElementById('posterZone');

  function openSettings(){
    backdrop.classList.add('open');
    renderSettingsLists();
    document.getElementById('posterInterval').value = state.posterIntervalSec;
  }
  function closeSettings(){
    backdrop.classList.remove('open');
  }
  openSettingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', closeSettings);
  posterZone.addEventListener('click', openSettings);
  backdrop.addEventListener('click', (e)=>{
    if(e.target === backdrop) closeSettings();
  });

  // Poster settings
  const posterList = document.getElementById('posterList');
  const posterIntervalInput = document.getElementById('posterInterval');
  const addPosterBtn = document.getElementById('addPosterBtn');
  const posterUrlInput = document.getElementById('posterUrl');

  posterIntervalInput.addEventListener('change', ()=>{
    const v = Math.max(1, Number(posterIntervalInput.value) || 6);
    state.posterIntervalSec = v;
    state.posterCountdown = v;
  });

  addPosterBtn.addEventListener('click', ()=>{
    const url = posterUrlInput.value.trim();
    if(!url) return;
    state.posters.push(url);
    posterUrlInput.value = '';
    renderSettingsLists();
    // 今のポスター表示は維持
  });

  // Magnet settings
  const addMagBtn = document.getElementById('addMagBtn');
  const magValueInput = document.getElementById('magValue');
  const magTypeSelect = document.getElementById('magType');
  const magList = document.getElementById('magList');

  addMagBtn.addEventListener('click', ()=>{
    const v = magValueInput.value.trim();
    if(!v) return;
    const type = magTypeSelect.value;
    state.magnets[type].push(v);
    magValueInput.value = '';
    renderMagnets();
    renderSettingsLists();
  });

  function renderSettingsLists(){
    // posters
    posterList.innerHTML = '';
    state.posters.forEach((url, idx)=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:720px;">${escapeHtml(url)}</div>`;
      const rm = document.createElement('div');
      rm.className = 'rm';
      rm.textContent = '削除';
      rm.addEventListener('click', ()=>{
        state.posters.splice(idx,1);
        state.posterIndex = Math.min(state.posterIndex, Math.max(0, state.posters.length-1));
        if(state.posters.length === 0){
          state.posters.push('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1600&q=80');
        }
        showPoster();
        renderSettingsLists();
      });
      item.appendChild(rm);
      posterList.appendChild(item);
    });

    // magnets
    magList.innerHTML = '';
    [['name','名前'],['car','車'],['dest','行先']].forEach(([type, label])=>{
      state.magnets[type].forEach((v, idx)=>{
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `<div><span class="badge" style="margin-right:10px;">${label}</span>${escapeHtml(v)}</div>`;
        const rm = document.createElement('div');
        rm.className = 'rm';
        rm.textContent = '削除';
        rm.addEventListener('click', ()=>{
          state.magnets[type].splice(idx,1);
          renderMagnets();
          renderSettingsLists();
        });
        item.appendChild(rm);
        magList.appendChild(item);
      });
    });
  }

  // ---- Popover handling ----
  const pop = document.getElementById('popover');

  function closePopover(){
    pop.style.display = 'none';
    pop.innerHTML = '';
  }
  window.addEventListener('click', (e)=>{
    // modal open中はpopoverを閉じない（ただしクリックで閉じたいならここを変える）
    if(backdrop.classList.contains('open')) return;
    if(pop.style.display === 'none') return;
    if(!pop.contains(e.target)) closePopover();
  });
  window.addEventListener('resize', closePopover);
  window.addEventListener('scroll', closePopover, true);

  function placePopoverNearRect(rect){
    const pad = 12;
    // 初期は右下に出す
    let left = rect.right + 10;
    let top  = rect.top;

    pop.style.display = 'block';
    pop.style.left = '0px';
    pop.style.top = '0px';
    pop.style.visibility = 'hidden';

    // measure
    const w = pop.offsetWidth;
    const h = pop.offsetHeight;

    // 画面内に収める
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    if(left + w + pad > vw){
      left = rect.left - w - 10;
    }
    if(left < pad) left = pad;

    if(top + h + pad > vh){
      top = vh - h - pad;
    }
    if(top < pad) top = pad;

    pop.style.left = `${left}px`;
    pop.style.top = `${top}px`;
    pop.style.visibility = 'visible';
  }

  // Time popover (UI time picker)
  function openTimePopover(rowIndex, rect){
    pop.innerHTML = `
      <div class="pop-head">
        <div class="h">帰社時間を選択</div>
        <button class="icon-btn" id="popClose">×</button>
      </div>
      <div class="pop-body">
        <div class="muted">※OS依存の入力は使わず、一覧から選択（デモ）</div>
        <div class="pick-grid" id="timeGrid"></div>
        <div class="row">
          <button class="btn" id="clearTime">クリア</button>
        </div>
      </div>
    `;
    pop.querySelector('#popClose').addEventListener('click', closePopover);

    const grid = pop.querySelector('#timeGrid');
    // 30分刻み 8:00〜20:00（デモ）
    const times = [];
    for(let h=8; h<=20; h++){
      times.push(`${String(h).padStart(2,'0')}:00`);
      if(h!==20) times.push(`${String(h).padStart(2,'0')}:30`);
    }
    times.forEach(t=>{
      const btn = document.createElement('div');
      btn.className = 'pick';
      btn.innerHTML = `<div style="font-weight:950;">${t}</div><div class="badge">選択</div>`;
      btn.addEventListener('click', ()=>{
        state.rows[rowIndex].time = t;
        renderTable();
        closePopover();
      });
      grid.appendChild(btn);
    });

    pop.querySelector('#clearTime').addEventListener('click', ()=>{
      state.rows[rowIndex].time = '';
      renderTable();
      closePopover();
    });

    placePopoverNearRect(rect);
  }

  // Select popover for name/dest
  function openSelectPopover(rowIndex, key, rect){
    const label = key === 'name' ? '氏名' : '行先（車も可）';
    const list = key === 'name'
      ? state.magnets.name.map(v=>({type:'name',label:v}))
      : [
          ...state.magnets.dest.map(v=>({type:'dest',label:v})),
          ...state.magnets.car.map(v=>({type:'car',label:v}))
        ];

    pop.innerHTML = `
      <div class="pop-head">
        <div class="h">${label} を追加</div>
        <button class="icon-btn" id="popClose">×</button>
      </div>
      <div class="pop-body">
        <div class="muted">タップで追加（複数OK）</div>
        <div class="pick-grid" id="pickGrid"></div>

        <div class="muted">カスタム指定（キーボード入力OK / OS依存で可）</div>
        <div class="row">
          <input type="text" id="customText" placeholder="自由入力（例: 打合せ / 資材置場 / 来客対応 など）" />
          <button class="btn primary" id="addCustom">追加</button>
        </div>

        <div class="row">
          <button class="btn" id="clearAll">このセルをクリア</button>
        </div>
      </div>
    `;

    pop.querySelector('#popClose').addEventListener('click', closePopover);

    const grid = pop.querySelector('#pickGrid');
    list.slice(0, 12).forEach(item=>{
      const b = document.createElement('div');
      b.className = 'pick';
      b.innerHTML = `
        <div style="font-weight:950;">${escapeHtml(item.label)}</div>
        <div class="badge">${item.type==='name'?'名前':item.type==='car'?'車':'行先'}</div>
      `;
      b.addEventListener('click', ()=>{
        state.rows[rowIndex][key].push({type:item.type, label:item.label});
        renderTable();
      });
      grid.appendChild(b);
    });

    pop.querySelector('#addCustom').addEventListener('click', ()=>{
      const v = pop.querySelector('#customText').value.trim();
      if(!v) return;
      state.rows[rowIndex][key].push({type:'custom', label:v});
      renderTable();
      closePopover();
    });

    pop.querySelector('#clearAll').addEventListener('click', ()=>{
      state.rows[rowIndex][key] = [];
      renderTable();
      closePopover();
    });

    placePopoverNearRect(rect);
  }

  // ---- Helpers ----
  function escapeHtml(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // ---- init ----
  renderTable();
  renderMagnets();

  // 初期テーマ
  setTheme('light');

})();
</script>
</body>
</html>
